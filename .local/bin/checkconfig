#!/usr/bin/env bash

cd ${XDG_CONFIG_HOME-:$HOME/.config} && shopt -s expand_aliases \
    && source ${XDG_CONFIG_HOME-:$HOME/.config}/shell/aliasrc || exit 1

all_entries=$(ls | sort)
cached=$(dfs ls-files -c | awk -F'/' '{print $1}' | sort | uniq)
new_entries=$(comm -23 <(comm -23 <(echo "$all_entries") <(echo "$cached")) <(sort .gitignore))

for entry in $new_entries
do
    read -rp "cache this directory [$entry] (y|n)?: " ret
    if [[ -n "$ret" && "$ret" =~ [N|n] ]]; then
	read -rp "remove [$entry] (y|n)?: " ret
	if [[ -z "$ret" || "$ret" =~ [Y|y] ]]; then
	    rm -rf "$entry" && printf -- "  -> %s removed\n\n" "$entry"
	else
	    printf -- "  -> added %s to .gitignore\n\n" "$entry" &&
		echo "$entry" >> .gitignore
	fi
    else
	dfs add "$entry" && printf -- "  -> %s added to dfs repo\n\n" "$entry"
    fi
done
